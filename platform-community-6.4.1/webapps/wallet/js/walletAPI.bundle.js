define((()=>(()=>{"use strict";var t={d:(e,a)=>{for(var i in a)t.o(a,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:a[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};function a(t,e,a,i,n,s,r,l){var o,c="function"==typeof t?t.options:t;if(e&&(c.render=e,c.staticRenderFns=a,c._compiled=!0),i&&(c.functional=!0),s&&(c._scopeId="data-v-"+s),r?(o=function(t){(t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),n&&n.call(this,t),t&&t._registeredComponents&&t._registeredComponents.add(r)},c._ssrRegister=o):n&&(o=l?function(){n.call(this,(c.functional?this.parent:this).$root.$options.shadowRoot)}:n),o)if(c.functional){c._injectStyles=o;var d=c.render;c.render=function(t,e){return o.call(e),d(t,e)}}else{var h=c.beforeCreate;c.beforeCreate=h?[].concat(h,o):[o]}return{exports:t,options:c}}t.r(e),t.d(e,{init:()=>S,initAPI:()=>D});const i=a({data:()=>({isWalletEnabled:!1,isWalletInitialized:!1,loading:!0,needPassword:!1,isReadOnly:!0,wallet:null,walletAddress:null,principalContractDetails:null,error:null,settings:null,profileExtensionInstalled:!1}),created(){(eXo||!eXo.env)&&eXo.env.portal&&eXo.env.portal.userName&&eXo.env.portal.userName.length?(document.addEventListener("exo-wallet-init",this.init),document.addEventListener("exo-wallet-send-tokens",this.sendTokens),window.walletAPIInitialized=!0,this.init(),document.dispatchEvent(new CustomEvent("exo-wallet-installed"))):this.isWalletEnabled=!1},methods:{init(t){this.isWalletInitialized=!0,document.dispatchEvent(new CustomEvent("exo-wallet-init-loading"));try{this.loading=!0,this.error=null,this.needPassword=!1,this.principalContractDetails=null,this.walletAddress=null,this.wallet=null;const e=t&&t.detail;!this.profileExtensionInstalled&&e&&e.contractDetail&&e.contractDetail.name&&(this.registerExternalExtensions(this.$t("exoplatform.wallet.title.sendToken",{0:e.contractDetail.name})),this.profileExtensionInstalled=!0);let a=!1;if(e&&e.sender)if("space"===e.sender.type)a=!0,window.walletSpaceGroup=e.sender.id;else if(e.sender.id!==eXo.env.portal.userName)throw new Error(this.$t("exoplatform.wallet.warning.walletInitializationFailure"));return this.walletUtils.initSettings(a).then(((t,e)=>{if(this.handleError(e),this.settings=window.walletSettings||{},document.dispatchEvent(new CustomEvent("exo-wallet-settings-loaded",{detail:this.settings})),!this.profileExtensionInstalled&&this.settings&&this.settings.contractDetail&&this.settings.contractDetail.name&&(this.registerExternalExtensions(this.$t("exoplatform.wallet.title.sendToken",{0:this.settings.contractDetail.name})),this.profileExtensionInstalled=!0),!this.settings.walletEnabled)throw this.isWalletEnabled=!1,this.isReadOnly=!0,new Error(this.$t("exoplatform.wallet.warning.walletDisabled"));if(!this.settings.wallet||!this.settings.wallet.address)throw this.isReadOnly=!0,new Error(this.constants.ERROR_WALLET_NOT_CONFIGURED);if(!this.settings.contractAddress)throw this.isReadOnly=!0,new Error(this.$t("exoplatform.wallet.warning.noConfiguredToken"));return this.isWalletEnabled=!0,this.isReadOnly=!1,this.walletUtils.initWeb3()})).then(((t,e)=>{if(this.handleError(e),this.walletAddress=this.settings.wallet.address,this.wallet=this.settings.wallet,!this.walletAddress)throw this.isReadOnly=!0,new Error(this.$t("exoplatform.wallet.warning.walletNotConfigured"));if(!this.settings.browserWalletExists)throw this.isReadOnly=!0,new Error(this.$t("exoplatform.wallet.warning.walletReadonly"));if(this.needPassword=this.settings.browserWalletExists&&!this.settings.storedPassword,this.storedPassword=this.settings.storedPassword&&this.settings.browserWalletExists,this.isReadOnly=this.settings.isReadOnly,this.principalContractDetails=this.tokenUtils.getContractDetails(this.walletAddress),!this.principalContractDetails||!this.principalContractDetails.address||0!==this.principalContractDetails.address.indexOf("0x"))throw console.error("Principal token seems inconsistent",this.principalContractDetails),this.isReadOnly=!0,new Error(this.$t("exoplatform.wallet.warning.noConfiguredToken"));if(this.principalContractDetails.error)throw console.error("Error retrieving principal contract details",this.principalContractDetails.error,this.principalContractDetails),this.isReadOnly=!0,new Error(this.$t("exoplatform.wallet.warning.networkConnectionFailure"));if(!this.principalContractDetails.contract)throw console.error("Principal account in wallet isn't a token contract",this.principalContractDetails),this.isReadOnly=!0,new Error(this.$t("exoplatform.wallet.warning.noConfiguredToken"));if(!this.principalContractDetails.contract.options||!this.principalContractDetails.contract.options.from)throw console.error("Error retrieving sender address",this.principalContractDetails),this.isReadOnly=!0,new Error(this.$t("exoplatform.wallet.warning.walletInitializationFailure"))})).catch((t=>{const e=`${t}`;e.indexOf(this.constants.ERROR_WALLET_NOT_CONFIGURED)>=0?this.error=this.$t("exoplatform.wallet.warning.walletNotConfigured"):e.indexOf(this.constants.ERROR_WALLET_SETTINGS_NOT_LOADED)>=0?this.error=this.$t("exoplatform.wallet.warning.walletInitializationFailure"):e.indexOf(this.constants.ERROR_WALLET_DISCONNECTED)>=0?this.error=this.$t("exoplatform.wallet.warning.networkConnectionFailure"):(console.error("init method - error",t),this.error=t&&t.message||t)})).finally((()=>{this.loading=!1;const t={error:this.error,needPassword:this.needPassword,enabled:this.settings&&this.settings.enabled,symbol:this.principalContractDetails&&this.principalContractDetails.symbol};document.dispatchEvent(new CustomEvent("exo-wallet-init-result",{detail:t}))}))}catch(t){console.error("init method - error",t),this.loading=!1,document.dispatchEvent(new CustomEvent("exo-wallet-init-result",{detail:{error:t&&t.message||t,symbol:this.principalContractDetails&&this.principalContractDetails.symbol}}))}},handleError(t){if(t)throw t},sendTokens(t){try{if(!this.isWalletEnabled||this.isReadOnly)throw new Error(this.$t("exoplatform.wallet.warning.walletReadonly"));if(!this.principalContractDetails||!this.principalContractDetails.address||0!==this.principalContractDetails.address.indexOf("0x"))throw console.error("Principal token seems inconsistent",this.principalContractDetails),new Error(this.$t("exoplatform.wallet.warning.noConfiguredToken"));if(this.principalContractDetails.error||!this.principalContractDetails.contract||!this.principalContractDetails.contract.options||!this.principalContractDetails.contract.options.from)throw console.error("Principal token seems inconsistent",this.principalContractDetails),new Error(this.$t("exoplatform.wallet.warning.networkConnectionFailure"));if(this.error)return void document.dispatchEvent(new CustomEvent("exo-wallet-send-tokens-error",{detail:this.error}));const e=t&&t.detail;if(!e)return void document.dispatchEvent(new CustomEvent("exo-wallet-send-tokens-error",{detail:this.$t("exoplatform.wallet.warning.emptyPaymentRequest")}));const a=Number(e.amount),i=e.password,n=e.receiver,s=e.sender,r=e.label,l=e.message,o=this.settings.network;if(!a||Number.isNaN(parseFloat(a))||!Number.isFinite(a)||a<=0)return void document.dispatchEvent(new CustomEvent("exo-wallet-send-tokens-error",{detail:this.$t("exoplatform.wallet.warning.invalidPaymentAmount")}));if(!n||!n.type||!n.id)return void document.dispatchEvent(new CustomEvent("exo-wallet-send-tokens-error",{detail:this.$t("exoplatform.wallet.warning.emptyPaymentAmount")}));if(!(this.storedPassword||i&&i.length))return void document.dispatchEvent(new CustomEvent("exo-wallet-send-tokens-error",{detail:this.$t("exoplatform.wallet.warning.emptyPassword")}));try{if(!this.walletUtils.unlockBrowserWallet(this.storedPassword?this.settings.userP:this.walletUtils.hashCode(i)))return void document.dispatchEvent(new CustomEvent("exo-wallet-send-tokens-error",{detail:this.$t("exoplatform.wallet.warning.wrongPassword")}))}catch(t){return void document.dispatchEvent(new CustomEvent("exo-wallet-send-tokens-error",{detail:this.$t("exoplatform.wallet.warning.wrongPassword")}))}if(!this.wallet.tokenBalance||this.wallet.tokenBalance<a)return void document.dispatchEvent(new CustomEvent("exo-wallet-send-tokens-error",{detail:this.$t("exoplatform.wallet.warning.unsufficientFunds")}));const c=o.gasLimit,d=this.principalContractDetails.contract.methods.transfer,h=this.principalContractDetails.address,u=this.walletUtils.convertTokenAmountToSend(a,this.principalContractDetails.decimals);let p=null,w=null,m=null,f=null,g=null;return this.addressRegistry.searchWalletByTypeAndId(n.id,n.type).then((t=>{if(m=t,p=m&&m.address,!p||!p.length)throw new Error(this.$t("exoplatform.wallet.warning.receiverDoesntHaveWallet"))})).then((()=>this.addressRegistry.searchWalletByTypeAndId(s.id,s.type))).then((t=>{if(f=t,w=f&&f.address,!w||!w.length)throw new Error(this.$t("exoplatform.wallet.warning.senderDoesntHaveWallet"));if(w.toLowerCase()!==this.walletAddress.toLowerCase())throw new Error(this.$t("exoplatform.wallet.warning.incoherentSenderWallet"));if(w.toLowerCase()===p.toLowerCase())throw new Error(this.$t("exoplatform.wallet.warning.receiverMustBeDifferentFromSender"))})).then((()=>this.transactionUtils.getGasPrice())).then((t=>g=t)).then((()=>d(p,u).estimateGas({from:w,gas:c,gasPrice:g}))).catch((t=>{m&&f?(console.error("Error estimating transaction fee",{from:w,to:p,gas:c,gasPrice:g,balance:this.wallet.tokenBalance,amount:a},t),document.dispatchEvent(new CustomEvent("exo-wallet-send-tokens-error",{detail:this.$t("exoplatform.wallet.warning.errorSimulatingTransaction")}))):document.dispatchEvent(new CustomEvent("exo-wallet-send-tokens-error",{detail:t&&t.message||t}))})).then((t=>{if(!t)return;if(t>c)return void document.dispatchEvent(new CustomEvent("exo-wallet-send-tokens-error",{detail:this.$t("exoplatform.wallet.warning.lowPaymentTransactionFeeError")}));const e={from:w.toLowerCase(),to:p.toLowerCase(),value:0,gas:c,gasPrice:g,pending:!0,contractAddress:h,contractMethodName:"transfer",contractAmount:a,label:r,message:l,timestamp:Date.now()};return this.tokenUtils.sendContractTransaction(e,d,[p,u])})).then((t=>{t&&(document.dispatchEvent(new CustomEvent("exo-wallet-send-tokens-pending",{detail:t})),this.walletUtils.lockBrowserWallet())})).catch((t=>{console.error("sendTokens method - error",t),document.dispatchEvent(new CustomEvent("exo-wallet-send-tokens-error",{detail:t&&t.message||t}))}))}catch(t){document.dispatchEvent(new CustomEvent("exo-wallet-send-tokens-error",{detail:t&&t.message||t}))}},registerExternalExtensions(t){const e={title:t,icon:"uiIconLightBlue mdi mdi-send material-icons",order:30,enabled:t=>t.enabled&&!t.deleted,click:t=>{const e=t.username?"user":"space",a=t.username?t.username:t.prettyName;window.location.href=`${eXo.env.portal.context}/${eXo.env.portal.portalName}/wallet?receiver=${a}&receiver_type=${e}&principal=true`}};extensionRegistry.registerExtension("profile-extension","action",e),document.dispatchEvent(new CustomEvent("profile-extension-updated",{detail:e}))}}},void 0,void 0,!1,null,null,null).exports;var n=function(){var t=this,e=t._self._c;return e("v-app",{staticClass:"VuetifyApp",attrs:{id:t.appId,color:"transaprent",flat:""}},[t.isWalletEnabled?e("main",{attrs:{id:"walletEnabledContent"}},[e("v-layout",[e("v-flex",[e("v-app",{staticClass:"mb-4 application-toolbar"},[e("v-tabs",{attrs:{"slider-size":"4"},model:{value:t.tab,callback:function(e){t.tab=e},expression:"tab"}},[e("v-tab",[t._v(t._s(t.tabName))])],1),t._v(" "),e("v-tabs-items",{staticClass:"tabs-content",model:{value:t.tab,callback:function(e){t.tab=e},expression:"tab"}},[e("v-tab-item",{attrs:{eager:""}},[e("v-flex",[e("v-layout",{staticClass:"ms-0 me-0 pr-0",attrs:{row:"",wrap:""}},[e("wallet-reward-summary",{ref:"walletSummary",attrs:{wallet:t.wallet,"is-space":t.isSpace,"is-space-administrator":t.isSpaceAdministrator,"initialization-state":t.initializationState,"contract-details":t.contractDetails,"fiat-symbol":t.fiatSymbol,"selected-transaction-hash":t.selectedTransactionHash,"selected-contract-method-name":t.selectedContractMethodName},on:{refresh:function(e){return t.refreshWallet(!0)},"display-transactions":t.openAccountDetail,error:function(e){t.error=e}}}),t._v(" "),e("div",{staticClass:"my-8 walletRewardSetup"},[e("wallet-reward-setup",{ref:"walletSetup",attrs:{"is-space":t.isSpace,wallet:t.wallet,"initialization-state":t.initializationState,loading:t.loading},on:{loading:function(e){t.loading=!0},"end-loading":function(e){t.loading=!1},refresh:function(e){return t.init()},error:function(e){t.loading=!1,t.error=e}}})],1),t._v(" "),t.wallet&&t.contractDetails&&"DELETED"!==this.initializationState?[e("v-flex",{staticClass:"chartHistory WalletChart mt-6"},[t.loading?t._e():e("wallet-reward-transaction-history-chart-summary",{ref:"chartPeriodicityButtons",attrs:{"periodicity-label":t.periodicityLabel},on:{"period-changed":t.periodChanged,error:function(e){t.error=e}}})],1),t._v(" "),e("v-flex",{staticClass:"WalletChart transactionHistoryChart mb-4"},[e("wallet-reward-transaction-history-chart",{ref:"transactionHistoryChart",class:t.periodicity,attrs:{"transaction-statistics":t.transactionStatistics}})],1)]:t._e()],2)],1)],1)],1)],1)],1)],1),t._v(" "),e("wallet-reward-account-detail",{ref:"accountDetail",attrs:{"fiat-symbol":t.fiatSymbol,wallet:t.wallet,"contract-details":t.selectedAccount,"selected-transaction-hash":t.selectedTransactionHash,"selected-contract-method-name":t.selectedContractMethodName},on:{back:function(e){return t.back()}}}),t._v(" "),e("div",{attrs:{id:"walletDialogsParent"}})],1):t.isApplicationEnabled?t.loading?t._e():e("main",{attrs:{id:"walletDisabledContent"}},[e("v-layout",[e("v-flex",[e("v-card-title",{staticClass:"transparent",attrs:{flat:""}},[e("v-spacer"),t._v(" "),e("div",{staticClass:"alert alert-warning"},[e("i",{staticClass:"uiIconWarning"}),t._v("\n            "+t._s(t.$t("exoplatform.wallet.warning.noEnoughPrivileges"))+"\n          ")]),t._v(" "),e("v-spacer")],1)],1)],1)],1):e("main",{attrs:{id:"walletDisabledContent"}},[e("v-layout",{staticClass:"mt-7",attrs:{wrap:""}},[e("v-flex",{staticClass:"mx-auto text-center title",attrs:{xs12:""}},[t._v("\n        "+t._s(t.$t("exoplatform.wallet.info.walletApplicationDisabledPart1"))+"\n      ")]),t._v(" "),e("v-flex",{staticClass:"mt-2 mx-auto text-center title",attrs:{xs12:""}},[t._v("\n        "+t._s(t.$t("exoplatform.wallet.info.walletApplicationDisabledPart2"))+"\n      ")]),t._v(" "),e("v-flex",{staticClass:"mx-auto text-center title mt-7",attrs:{xs12:""}},[e("a",{staticClass:"requestFundsLink",attrs:{href:"https://www.exoplatform.com/rewarding-program",target:"_blank",rel:"noopener noreferrer"}},[t._v("\n          "+t._s(t.$t("exoplatform.wallet.info.walletApplicationDisabledLink"))+"\n        ")])])],1)],1),t._v(" "),e("wallet-notification-alert")],1)};n._withStripped=!0;const s=a({props:{isSpace:{type:Boolean,default:function(){return!1}}},data:()=>({isWalletEnabled:!1,isApplicationEnabled:!0,loading:!0,disabledYear:!0,gasPrice:null,disabledMonth:!1,isReadOnly:!0,isSpaceAdministrator:!1,seeAccountDetails:!1,seeAccountDetailsPermanent:!1,showSettingsModal:!1,browserWalletExists:!1,wallet:null,selectedTransactionHash:null,selectedContractMethodName:null,contractDetails:null,selectedAccount:null,initializationState:"NONE",fiatSymbol:"$",settings:null,error:null,transactionStatistics:null,periodicity:"year",selectedDate:(new Date).toISOString().substr(0,7)}),computed:{tabName(){return this.isSpace?this.$t("exoplatform.wallet.title.spaceWallet"):this.$t("exoplatform.wallet.title.myWallet")},appId(){return this.isSpace?"SpaceWalletApp":"WalletApp"},walletReadonly(){return this.isSpace&&!this.isSpaceAdministrator},walletAddress(){return this.wallet&&this.wallet.address},displayAccountsList(){return this.walletAddress},displayWalletResetOption(){return!this.loading&&!this.error&&this.walletAddress&&this.browserWalletExists},displayWarnings(){return this.displayEtherBalanceTooLow},gasPriceInEther(){return this.gasPrice&&window.localWeb3.utils.fromWei(String(this.gasPrice),"ether")||0},displayEtherBalanceTooLow(){return this.browserWalletExists&&!this.loading&&!this.error&&(!this.isSpace||this.isSpaceAdministrator)&&this.gasPriceInEther&&(!this.etherBalance||this.etherBalance<this.walletUtils.gasToEther(this.settings.network.gasLimit,this.gasPriceInEther))},etherBalance(){return this.wallet&&this.wallet.etherBalance||0},periodicityLabel(){return this.transactionStatistics&&this.transactionStatistics.periodicityLabel}},watch:{seeAccountDetails(){if(this.seeAccountDetails){$("body").addClass("hide-scroll");const t=this;setTimeout((()=>{t.seeAccountDetailsPermanent=!0}),200),this.$refs.accountDetail.open()}else $("body").removeClass("hide-scroll"),this.seeAccountDetailsPermanent=!1}},created(){if(!eXo&&eXo.env||!eXo.env.portal||!eXo.env.portal.userName||!eXo.env.portal.userName.length)return void(this.isWalletEnabled=!1);if(eXo.env.portal.profileOwner&&eXo.env.portal.profileOwner!==eXo.env.portal.userName)return void(this.isWalletEnabled=!1);if(this.isSpace&&(!window.walletSpaceGroup||!window.walletSpaceGroup.length))return void(this.isWalletEnabled=!1);const t=this;$(document).on("keydown",(e=>{27===e.which&&t.seeAccountDetailsPermanent&&!$(".v-dialog:visible").length&&t.back()})),document.addEventListener("exo.wallet.modified",this.walletUpdated),document.addEventListener("exo.contract.modified",this.reloadContract),this.$nextTick((()=>{this.init().then((()=>this.etherBalance&&this.transactionUtils.getGasPrice())).then((t=>this.gasPrice=t||window.walletSettings.network.normalGasPrice)).then((()=>{this.$refs.walletSummary&&this.wallet&&this.wallet.address&&(this.$refs.walletSummary.prepareSendForm(),this.$refs.walletSummary.loadPendingTransactions()),this.checkOpenTransaction(),this.$forceUpdate()})).catch((t=>{console.error("An error occurred while on initialization",t),this.error=this.$t("exoplatform.wallet.warning.walletDisconnected")}))}))},methods:{init(){return this.loading=!0,this.error=null,this.seeAccountDetails=!1,this.selectedAccount=null,this.wallet=null,this.walletUtils.initSettings(this.isSpace,!0).then(((t,e)=>{if(this.handleError(e),this.settings=window.walletSettings||{wallet:{},network:{}},this.wallet=this.settings.wallet,this.isApplicationEnabled=this.settings.enabled,!this.settings.walletEnabled||!this.isApplicationEnabled)throw this.isWalletEnabled=!1,this.$forceUpdate(),new Error(this.$t("exoplatform.wallet.warning.walletDisconnected"));if(this.isWalletEnabled=!0,this.isSpaceAdministrator=this.settings.wallet.spaceAdministrator,!this.settings.wallet.address)throw new Error(this.constants.ERROR_WALLET_NOT_CONFIGURED);this.$forceUpdate()})).then(((t,e)=>{if(this.handleError(e),this.isReadOnly||!window.localWeb3)return this.walletUtils.initWeb3(this.isSpace)})).then(((t,e)=>{if(this.handleError(e),this.contractDetails)return this.reloadContract();this.contractDetails=this.tokenUtils.getContractDetails(this.walletAddress)})).then(((t,e)=>(this.handleError(e),this.isReadOnly=this.settings.isReadOnly||!this.wallet,this.browserWalletExists=this.settings.browserWalletExists,this.initializationState=this.settings.wallet.initializationState,this.fiatSymbol=this.settings.fiatSymbol||"$",this.$nextTick()))).then((()=>this.periodChanged(this.periodicity))).catch((t=>{const e=`${t}`;e.indexOf(this.constants.ERROR_WALLET_NOT_CONFIGURED)>=0?this.browserWalletExists=this.settings.browserWalletExists=!1:e.indexOf(this.constants.ERROR_WALLET_SETTINGS_NOT_LOADED)>=0?this.error=this.$t("exoplatform.wallet.warning.walletInitializationFailure"):e.indexOf(this.constants.ERROR_WALLET_DISCONNECTED)>=0?this.error=this.$t("exoplatform.wallet.warning.networkConnectionFailure"):(console.error("init method - error",t),this.error=e)})).then((()=>this.$refs.walletSetup&&this.$refs.walletSetup.init())).then(this.$nextTick).finally((()=>{this.loading=!1,this.$forceUpdate()}))},walletUpdated(t){t&&t.detail&&t.detail.string&&this.walletAddress===t.detail.string.toLowerCase()&&this.refreshWallet()},reloadContract(){return this.tokenUtils.reloadContractDetails(this.walletAddress).then((t=>this.contractDetails=t))},openAccountDetail(t,e){this.error=null,this.selectedAccount=this.contractDetails,this.selectedTransactionHash=e,this.selectedContractMethodName=t,this.seeAccountDetails=!0,this.$nextTick((()=>{const t=this;$(".v-overlay").on("click",(()=>{t.back()}))}))},back(){this.seeAccountDetails=!1,this.seeAccountDetailsPermanent=!1,this.selectedAccount=null},handleError(t){if(t)throw t},newPendingTransaction(t){this.$refs&&this.$refs.walletSummary&&this.$refs.walletSummary.loadPendingTransactions(),this.walletUtils.watchTransactionStatus(t.hash,(()=>{this.reloadContract().then(this.$refs.transactionHistoryChart.initializeChart)}))},checkOpenTransaction(){if(document.location.search&&document.location.search.length){const t=document.location.search.substring(1),e=JSON.parse(`{"${decodeURI(t).replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')}"}`);this.walletAddress&&this.contractDetails&&e&&e.hash&&(this.openAccountDetail(null,e.hash),window.history.replaceState("",window.document.title,window.location.href.split("?")[0]))}},periodChanged(t,e){this.periodicity=t,this.selectedDate=e,this.$refs.transactionHistoryChart&&this.transactionUtils.getTransactionsAmounts(this.walletAddress,this.periodicity,this.selectedDate).then((t=>{this.transactionStatistics=t})).catch((t=>this.error=String(t)))},refreshWallet(t){return this.addressRegistry.refreshWallet(this.wallet,t)}}},n,[],!1,null,null,null).exports;var r=function(){var t=this,e=t._self._c;return e("v-flex",{staticClass:"elevation-0 me-3",attrs:{id:"walletSummary"}},[[e("v-container",{staticClass:"mt-3 px-1 py-1",attrs:{fluid:"","ps-3":"","pe-0":""}},[e("v-layout",{staticClass:"WalletSummary",attrs:{wrap:"",color:"transparent"}},[t.walletReadonly?t._e():e("v-flex",{staticClass:"summaryCard mr-3"},[t.walletAddress&&t.contractDetails&&"DELETED"!==this.initializationState?e("div",{staticClass:"border-box-sizing"},[e("button",{staticClass:"btn ignore-vuetify-classes me-1",on:{click:t.openExchangeDrawer}},[t._v("\n              "+t._s(t.$t("exoplatform.wallet.label.exchanges"))+"\n            ")])]):t._e(),t._v(" "),t.walletAddress&&t.contractDetails&&"DELETED"!==this.initializationState?e("wallet-reward-summary-buttons",{ref:"walletSummaryActions",attrs:{"is-space":t.isSpace,"is-space-administrator":t.isSpaceAdministrator,"contract-details":t.contractDetails,wallet:t.wallet,"is-read-only":t.isReadOnly},on:{"display-transactions":t.openAccountDetail,"transaction-sent":t.newPendingTransaction,error:function(e){t.error=e}}}):t._e()],1),t._v(" "),t.walletReadonly?t._e():e("v-flex",{staticClass:"summaryCard"},[t.walletAddress&&t.contractDetails&&"DELETED"!==this.initializationState?e("wallet-reward-summary-transaction",{attrs:{"contract-details":t.contractDetails,"wallet-address":t.walletAddress,"fiat-symbol":t.fiatSymbol,wallet:t.wallet,"selected-transaction-hash":t.selectedTransactionHash,"selected-contract-method-name":t.selectedContractMethodName,"pending-transactions-count":t.pendingTransactionsCount},on:{"display-transactions":function(e){return t.$emit("display-transactions")},error:function(e){return t.$emit("error",e)}}}):t._e()],1),t._v(" "),e("v-flex",{staticClass:"summaryBalance"},[t.walletAddress&&!t.loading&&t.contractDetails&&"DELETED"!==this.initializationState?e("wallet-reward-summary-balance",{staticClass:"mt-1 mx-3 px-1 py-1",attrs:{wallet:t.wallet,"contract-details":t.contractDetails},on:{refresh:function(e){return t.$emit("refresh")}}}):t._e()],1),t._v(" "),t.walletReadonly?t._e():e("v-flex",{staticClass:"fixedItems no-wrap"},[t.pendingTransactionsCount?e("div",{staticClass:"pb-0 mx-4 mt-2",attrs:{"primary-title":""}},[e("v-badge",{attrs:{title:t.$t("exoplatform.wallet.message.transactionInProgress"),color:"red",right:!t.$vuetify.rtl}},[e("span",{attrs:{slot:"badge"},slot:"badge"},[t._v("\n                "+t._s(t.pendingTransactionsCount)+"\n              ")]),t._v(" "),e("v-progress-circular",{attrs:{color:"primary",indeterminate:"",size:"20"}})],1)],1):t._e(),t._v(" "),t.displayWarnings?e("div",{staticClass:"ms-2 mt-2",attrs:{id:"etherTooLowWarningParent"}},[e("v-icon",{attrs:{title:t.$t("exoplatform.wallet.warning.noEnoughFunds"),color:"orange"}},[t._v("\n              warning\n            ")])],1):t._e(),t._v(" "),e("wallet-reward-toolbar-menu",{ref:"walletAppMenu",attrs:{"is-space":t.isSpace,"is-space-administrator":t.isSpaceAdministrator,wallet:t.wallet},on:{refresh:function(e){return t.init()}}})],1)],1)],1)]],2)};r._withStripped=!0;const l=a({props:{wallet:{type:Object,default:function(){return null}},isSpaceAdministrator:{type:Boolean,default:function(){return!1}},isSpace:{type:Boolean,default:function(){return!1}},initializationState:{type:String,default:function(){return null}},contractDetails:{type:Object,default:function(){return null}},displayWarnings:{type:Boolean,default:!1},fiatSymbol:{type:String,default:function(){return"$"}},selectedTransactionHash:{type:String,default:function(){return null}},selectedContractMethodName:{type:String,default:function(){return null}}},data:()=>({updatePendingTransactionsIndex:1,pendingTransactions:{},lastTransaction:null,walletRewards:[]}),computed:{walletAddress(){return this.wallet&&this.wallet.address},pendingTransactionsCount(){return this.updatePendingTransactionsIndex&&Object.keys(this.pendingTransactions).length},walletReadonly(){return this.isSpace&&!this.isSpaceAdministrator}},methods:{requestAccessAuthorization(){return fetch(`/portal/rest/wallet/api/account/requestAuthorization?address=${this.walletAddress}`,{credentials:"include"}).then((t=>{if(!t||!t.ok)throw new Error(this.$t("exoplatform.wallet.error.errorRequestingAuthorization"));this.$emit("refresh")})).catch((t=>{this.$emit("error",String(t))}))},loadPendingTransactions(){return Object.keys(this.pendingTransactions).forEach((t=>delete this.pendingTransactions[t])),this.transactionUtils.loadTransactions(this.walletAddress,this.contractDetails,this.pendingTransactions,!0,100).then((t=>{this.updatePendingTransactionsIndex++,t.forEach((t=>{this.walletUtils.watchTransactionStatus(t.hash,(t=>{this.pendingTransactions[t.hash]&&delete this.pendingTransactions[t.hash],this.updatePendingTransactionsIndex++}))}))}))},openExchangeDrawer(){this.$refs.walletSummaryActions.open()},prepareSendForm(){this.$refs.walletSummaryActions?.init()}}},r,[],!1,null,null,null).exports;var o=function(){var t=this,e=t._self._c;return e("v-flex",[e("div",{staticClass:"summaryBalanceLabels"},[e("span",{staticClass:"balance"},[t._v(" "+t._s(t.$t("exoplatform.wallet.label.balance"))+" : ")]),t._v(" "),e("span",{staticClass:"symbol"},[t._v(" "+t._s(t.contractDetails.symbol)+" ")]),t._v("  "+t._s(t.balance)+"\n    "),e("v-btn",{staticClass:"mr-0 me-0",attrs:{id:"walletAppMenuRefreshButton",title:t.$t("exoplatform.wallet.button.refreshWallet"),icon:"",text:""},on:{click:function(e){return t.$emit("refresh")}}},[e("v-icon",{staticClass:"mb-1",attrs:{size:"24"}},[t._v("\n        refresh\n      ")])],1)],1)])};o._withStripped=!0;const c=a({props:{wallet:{type:Object,default:function(){return null}},contractDetails:{type:Object,default:function(){return{}}}},computed:{balance(){return this.wallet&&this.wallet.tokenBalance&&this.walletUtils.toFixed(this.wallet.tokenBalance)||0},symbol(){return this.contractDetails&&this.contractDetails.symbol||""}}},o,[],!1,null,null,null).exports;var d=function(){var t=this,e=t._self._c;return e("exo-drawer",{ref:"walletSummaryActions",attrs:{right:!t.$vuetify.rtl}},[e("template",{slot:"title"},[e("span",{staticClass:"mx-2"},[t._v(" "+t._s(t.$t("exoplatform.wallet.label.exchanges"))+" ")])]),t._v(" "),e("template",{slot:"content"},[e("div",{staticClass:"walletSummaryActions mx-4"},[e("v-flex",{staticClass:"walletSummaryAction"},[e("wallet-reward-send-tokens-modal",{ref:"sendTokensModal",attrs:{wallet:t.wallet,"is-read-only":t.isReadOnly,"contract-details":t.contractDetails},on:{sent:function(e){return t.$emit("transaction-sent",e)},error:function(e){return t.$emit("error",e)}}})],1),t._v(" "),e("v-flex",{staticClass:"walletSummaryAction"},[e("v-btn",{staticClass:"btn",attrs:{color:"primary",block:""},on:{click:t.openRequestFundsModal}},[e("v-icon",{staticClass:"mr-6"},[t._v("\n            mdi-cash-multiple\n          ")]),t._v("\n          "+t._s(t.$t("exoplatform.wallet.button.requestFunds"))+"\n        ")],1),t._v(" "),e("wallet-reward-request-funds-modal",{ref:"walletRequestFundsModal",attrs:{"wallet-address":t.walletAddress,"contract-details":t.contractDetails}})],1)],1)])],2)};d._withStripped=!0;const h=a({props:{wallet:{type:Object,default:function(){return null}},contractDetails:{type:Array,default:function(){return[]}},isReadOnly:{type:Boolean,default:function(){return!1}}},computed:{walletAddress(){return this.wallet&&this.wallet.address}},methods:{init(t){if(document.location.search&&document.location.search.length){const e=document.location.search.substring(1),a=JSON.parse(`{"${decodeURI(e).replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')}"}`);if(a&&a.receiver&&a.receiver_type){if(this.isReadOnly||t)throw new Error(this.$t("exoplatform.wallet.warning.walletReadonly"));this.open(),this.$nextTick((()=>{this.$refs.sendTokensModal.prepareSendForm(a.receiver,a.receiver_type,a.amount,a.id)}))}}},open(){this.$refs.walletSummaryActions.open()},openRequestFundsModal(){this.$refs.walletRequestFundsModal.open(),this.$refs.walletRequestFundsModal.init()}}},d,[],!1,null,null,null).exports;var u=function(){var t=this,e=t._self._c;return e("div",{staticClass:"border-box-sizing clickable"},[e("button",{staticClass:"btn ignore-vuetify-classes",on:{click:t.displayTransactionList}},[t._v("\n    "+t._s(t.$t("exoplatform.wallet.label.lastTransaction"))+"\n  ")]),t._v(" "),e("wallet-reward-account-detail",{ref:"accountDetail",attrs:{"fiat-symbol":t.fiatSymbol,wallet:t.wallet,"contract-details":t.contractDetails,"selected-transaction-hash":t.selectedTransactionHash,"selected-contract-method-name":t.selectedContractMethodName},on:{back:function(e){return t.back()}}})],1)};u._withStripped=!0;const p=a({props:{walletAddress:{type:String,default:function(){return null}},contractDetails:{type:Object,default:function(){return{}}},pendingTransactionsCount:{type:Number,default:function(){return 0}},wallet:{type:Object,default:function(){return null}},fiatSymbol:{type:String,default:function(){return"$"}},selectedTransactionHash:{type:String,default:function(){return null}},selectedContractMethodName:{type:String,default:function(){return null}}},data:()=>({loadingTransaction:!1,lastTransaction:null,lastTransactionSent:null}),computed:{lastTransactionSign(){return this.lastTransaction&&this.lastTransaction.contractAmount&&(this.lastTransactionSent?"-":"+")||""}},watch:{pendingTransactionsCount(t,e){t!==e&&this.refreshLastTransaction()},contractDetails(){this.refreshLastTransaction()},lastTransaction(){if(this.lastTransaction&&this.lastTransaction.pending){const t=this;this.walletUtils.watchTransactionStatus(this.lastTransaction.hash,(e=>{e&&t.lastTransaction&&t.lastTransaction.hash===e.hash&&(Object.assign(t.lastTransaction,e),t.$forceUpdate())}))}}},created(){this.refreshLastTransaction()},methods:{displayTransactionList(){this.$refs.accountDetail.open()},refreshLastTransaction(){this.contractDetails&&this.contractDetails.address&&this.walletAddress&&(this.loadingTransaction=!0,this.transactionUtils.getStoredTransactions(this.walletAddress,this.contractDetails.address,10).then((t=>{this.lastTransaction=t&&t.length&&t[0],this.lastTransactionSent=this.lastTransaction&&this.lastTransaction.contractAmount&&this.lastTransaction.from&&this.lastTransaction.from.toLowerCase()===this.walletAddress.toLowerCase()})).catch((t=>{this.$emit("error",t)})).finally((()=>this.loadingTransaction=!1)))}}},u,[],!1,null,null,null).exports;var w=function(){var t=this,e=t._self._c;return e("div",{attrs:{id:"walletAppMenu"}},[e("v-btn",{staticClass:"me-0 ms-0",attrs:{id:"walletAppMenuSettingsButton",title:t.$t("exoplatform.wallet.button.security"),icon:"",text:""},on:{click:function(e){return t.openSettings()}}},[e("v-icon",{attrs:{size:"24"}},[t._v("\n      fa-cog\n    ")])],1)],1)};w._withStripped=!0;const m=a({props:{isSpace:{type:Boolean,default:function(){return!1}},isSpaceAdministrator:{type:Boolean,default:function(){return!1}},wallet:{type:Object,default:function(){return null}}},methods:{openSettings(){return"space"===this.wallet.type?window.location.href=`${eXo.env.portal.context}/g/:spaces:${eXo.env.portal.spaceGroup}/${eXo.env.portal.spaceName}/settings?walletSetting`:window.location.href=`${eXo.env.portal.context}/${eXo.env.portal.portalName}/settings?walletSetting`}}},w,[],!1,null,null,null).exports,f=a({extends:VueChart.Line,props:{transactionStatistics:{type:Object,default:function(){return null}}},data:()=>({incomeGradient:null,outcomeGradient:null}),watch:{transactionStatistics(){this.initializeChart()}},methods:{initializeChart(){this.transactionStatistics&&(this.incomeGradient=this.$refs.canvas.getContext("2d").createLinearGradient(0,0,0,450),this.outcomeGradient=this.$refs.canvas.getContext("2d").createLinearGradient(0,0,0,450),this.outcomeGradient.addColorStop(0,"rgba(255, 0,0, 0.5)"),this.outcomeGradient.addColorStop(.5,"rgba(255, 0, 0, 0.25)"),this.outcomeGradient.addColorStop(1,"rgba(255, 0, 0, 0)"),this.incomeGradient.addColorStop(0,"rgba(0, 231, 255, 0.9)"),this.incomeGradient.addColorStop(.5,"rgba(0, 231, 255, 0.25)"),this.incomeGradient.addColorStop(1,"rgba(0, 231, 255, 0)"),this.renderChart({labels:this.transactionStatistics.labels,datasets:[{label:this.$t("exoplatform.wallet.chart.Income"),borderColor:"#05CBE1",pointBackgroundColor:"white",pointBorderColor:"white",borderWidth:1,backgroundColor:this.incomeGradient,data:this.transactionStatistics.income},{label:this.$t("exoplatform.wallet.chart.Outcome"),borderColor:"#FC2525",pointBackgroundColor:"white",pointBorderColor:"white",borderWidth:1,backgroundColor:this.outcomeGradient,data:this.transactionStatistics.outcome}]},{responsive:!0,maintainAspectRatio:!1}))}}},void 0,void 0,!1,null,null,null).exports;var g=function(){var t=this,e=t._self._c;return e("v-layout",{attrs:{"pe-1":""}},[e("v-flex",{staticClass:"periodicityLabel",attrs:{"text-start":"","pt-2":"",id:t.id}},[e("v-menu",{ref:"selectDateMenu",staticClass:"dateSelector",attrs:{"content-class":t.menuId,transition:"scale-transition","offset-y":"",attach:""},scopedSlots:t._u([{key:"activator",fn:function({on:a}){return[e("v-chip",t._g({attrs:{color:"primary"}},a),[e("v-icon",{staticClass:"me-1"},[t._v("event")]),t._v("\n          "+t._s(t.periodicityLabel)+"\n        ")],1)]}}]),model:{value:t.selectDateMenu,callback:function(e){t.selectDateMenu=e},expression:"selectDateMenu"}},[t._v(" "),e("v-date-picker",{ref:"datePicker",staticClass:"border-box-sizing",attrs:{type:t.periodicity,locale:t.lang,"show-current":!1,max:t.maxDate,min:"2018"},on:{input:t.selectPeriod,"update:picker-date":t.selectPeriod},model:{value:t.selectedPickerDate,callback:function(e){t.selectedPickerDate=e},expression:"selectedPickerDate"}})],1)],1),t._v(" "),e("v-flex",{attrs:{"text-end":""}},[e("v-btn-toggle",{staticClass:"periodicityButtons elevation-1",model:{value:t.periodicity,callback:function(e){t.periodicity=e},expression:"periodicity"}},[e("v-btn",{attrs:{disabled:"year"===t.periodicity,value:"year",text:""}},[t._v("\n        "+t._s(t.$t("exoplatform.wallet.chart.year"))+"\n      ")]),t._v(" "),e("v-btn",{attrs:{disabled:"month"===t.periodicity,value:"month",text:""}},[t._v("\n        "+t._s(t.$t("exoplatform.wallet.chart.month"))+"\n      ")])],1)],1)],1)};g._withStripped=!0;const v=a({props:{periodicityLabel:{type:String,default:function(){return null}}},data:()=>({selectDateMenu:!1,id:`DatePicker${parseInt(1e4*Math.random())}`,menuId:`DatePickerMenu${parseInt(1e4*Math.random())}`,selectedPickerDate:(new Date).toISOString().substr(0,7),selectedDate:null,lang:"en",periodicity:"month"}),mounted(){$(".periodicityLabel span").on("click",(t=>{t.target&&!$(t.target).parents(`#${this.id}`).length&&(this.selectDateMenu=!1)})),$(document).on("click",(t=>{t.target&&!$(t.target).parents(`.${this.menuId}`).length&&(this.selectDateMenu=!1)}))},computed:{maxDate(){return"year"===this.periodicity&&(new Date).toISOString().substr(0,4)}},watch:{periodicity(){this.selectedPickerDate=this.selectedDate=(new Date).toISOString().substr(0,7),this.updateDatePickerSelection(),this.$emit("period-changed",this.periodicity,this.selectedDate)},selectedDate(){this.$emit("period-changed",this.periodicity,this.selectedDate)}},created(){this.lang=eXo.env.portal.language},methods:{updateDatePickerSelection(){"month"===this.periodicity?this.$refs.datePicker&&(this.$refs.datePicker.activePicker="MONTH"):"year"===this.periodicity&&this.$refs.datePicker&&(this.$refs.datePicker.activePicker="YEAR")},openDatePicker(){this.updateDatePickerSelection(),this.selectDateMenu=!0},closeDatePicker(){this.selectDateMenu=!1},selectPeriod(t){if(t&&this.selectedDate!==t)if("month"===this.periodicity){if(t.indexOf("undefined")>=0||t.indexOf("Na")>=0||t.length<7)return;this.selectedDate=t}else if("year"===this.periodicity){if(t.length<4)return;this.selectedDate=`${t.substring(0,4)}-01`}}}},g,[],!1,null,null,null).exports;var y=function(){var t=this,e=t._self._c;return e("v-tooltip",{attrs:{bottom:""},scopedSlots:t._u([{key:"activator",fn:function({on:a,attrs:i}){return[e("div",t._g(t._b({},"div",i,!1),a),[e("v-btn",{attrs:{ripple:!1,icon:"",color:"primary"},on:{click:function(e){return t.sendWallet(e)}}},[e("v-icon",{staticClass:"font-weight-bold error-color pa-2 mt-n1",attrs:{size:"18"}},[t._v("â±®")])],1)],1)]}}])},[t._v(" "),e("span",[t._v("\n    "+t._s(t.$t("exoplatform.wallet.title.sendMeeds"))+" \n  ")])])};y._withStripped=!0;const b=a({props:{identity:{type:Object,default:null}},computed:{identityId(){return this.identity&&this.identity.id}},methods:{sendWallet(t){t.preventDefault(),t.stopPropagation();const e=this.identity&&this.identity.username?"user":"space",a=this.identity&&this.identity.username?this.identity.username:this.identity.prettyName;window.location.href=`${eXo.env.portal.context}/${eXo.env.portal.portalName}/wallet?receiver=${a}&receiver_type=${e}&principal=true`}}},y,[],!1,null,null,null).exports;Vue.use(WalletCommon);const x={"wallet-app":s,"wallet-reward-summary":l,"wallet-reward-summary-balance":c,"wallet-reward-summary-buttons":h,"wallet-reward-summary-transaction":p,"wallet-reward-toolbar-menu":m,"wallet-reward-transaction-history-chart":f,"wallet-reward-transaction-history-chart-summary":v,"popover-wallet-button":b};for(const t in x)Vue.component(t,x[t]);Vue.use(Vuetify);const C=eXo&&eXo.env&&eXo.env.portal&&eXo.env.portal.language||"en",E=`${eXo.env.portal.context}/${eXo.env.portal.rest}/i18n/bundle/locale.addon.Wallet-${C}.json`;function D(){window.walletAPIInitialized||exoi18n.loadLanguageAsync(C,E).then((t=>{window.require(["SHARED/Web3","SHARED/walletCommon"],((e,a)=>{Vue.use(a);const n=new Vuetify(Object.assign({},eXo.env.portal.vuetifyPreset));n.theme={disable:!0},window.LocalWeb3=e,new Vue({render:t=>t(i),i18n:t,vuetify:n}).$mount("#WalletAPIApp")}))}))}function S(){window.walletAddonInstalled=!0,document.addEventListener("profile-extension-init",(()=>{document.dispatchEvent(new CustomEvent("exo-wallet-init"))}))}return document.addEventListener("exo-wallet-init",(()=>{D()})),document.dispatchEvent(new CustomEvent("exo-wallet-api-initialized")),e})()));